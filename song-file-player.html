<link rel="import" href="../paper-material/paper-material.html" />
<link rel="import" href="../paper-fab/paper-fab.html" />
<link rel="import" href="../paper-icon-button/paper-icon-button.html" />
<link rel="import" href="../paper-button/paper-button.html" />
<link rel="import" href="../iron-icons/iron-icons.html" />
<link rel="import" href="../iron-icons/av-icons.html" />
<link rel="import" href="../neon-animation/neon-shared-element-animatable-behavior.html">
<link rel="import" href="../paper-progress/paper-progress.html" />
<link rel="import" href="../neon-animation/neon-animated-pages.html" />
<link rel="import" href="../neon-animation/neon-animations.html" />
<link rel="import" href="../paper-toast/paper-toast.html" />

<dom-module id="song-file-player">
	<style>
		:host {
			width: 100%;
			height: 100%;
		}
		paper-progress {
			position: absolute;
			top: 1px;
			width: 100%;
			z-index: 5;
			--paper-progress-active-color: var(--text-primary-color);
			--paper-progress-container-color: transparent;
		}
		paper-material#container {
			height: 100%;
			background: var(--accent-color);
		}
		paper-material#wavecontainer {
			opacity: 0;
			transition: opacity 0.5s;
		}
		#controls {
			text-align: center;
			opacity: 0;
			transition: opacity 1s;
		}
		paper-icon-button::shadow #icon {
			width: 30px;
			height: 30px;
		}
		paper-icon-button[toggles] {
      transition: background-color 0.3s;
    }
    paper-icon-button[toggles][active] {
      background-color: rgba(0, 0, 0, 0.25);
    }

		#error {
			z-index: 999;
		}
		
		@keyframes flickerAnimation {
			0%   { opacity:1; }
			50%  { opacity:0; }
			100% { opacity:1; }
		}
		@-o-keyframes flickerAnimation{
			0%   { opacity:1; }
			50%  { opacity:0; }
			100% { opacity:1; }
		}
		@-moz-keyframes flickerAnimation{
			0%   { opacity:1; }
			50%  { opacity:0; }
			100% { opacity:1; }
		}
		@-webkit-keyframes flickerAnimation{
			0%   { opacity:1; }
			50%  { opacity:0; }
			100% { opacity:1; }
		}
		#notification {
			position: absolute;
			top: 40px;
			left: 10px;
			vertical-align: middle;
			margin: 25px 0;
			color: var(--text-primary-color);
			-webkit-animation: flickerAnimation 3s infinite;
			-moz-animation: flickerAnimation 3s infinite;
			-o-animation: flickerAnimation 3s infinite;
			animation: flickerAnimation 3s infinite;
		}
		@media (min-width: 600px) {
			#container {
				display: block;
			}
			#wavecontainer {
				opacity: 0;
				width: 70%;
				display: inline-block;
				vertical-align: middle;
				margin: 25px 0;
			}
			#controls {
				opacity: 0;
				width: 29%;
				display: inline-block;
				vertical-align: middle;
			}
		}
	</style>
	<template>
		<paper-progress id="loadmeter" value="{{loadingval}}"></paper-progress>
		<paper-material id="container" elevation="0">
			<p id="notification">Woah, Thats a big file. Processing...</p>
			<paper-material id="wavecontainer" elevation="0">
			</paper-material>
			<div id="controls" class="horizontal layout">
				<paper-icon-button class="flex" id='replaybutton' icon="av:replay-30" on-tap="replay"></paper-icon-button>
				<paper-icon-button class="flex"  id='pausebutton' icon="av:pause" on-tap="togglePlay"></paper-icon-button>
				<paper-icon-button class="flex"  id='mutebutton' icon="av:volume-off" on-tap="mute" toggles></paper-icon-button>
			</div>
		</paper-material>
		<paper-toast id="error" duration="3000" text="An error occured while downloading the file"></paper-toast>
	</template>
</dom-module>
<script>
	( function () {
		Polymer({
			is: 'song-file-player',
			behaviors: [
				Polymer.NeonSharedElementAnimatableBehavior
			],
			properties: {
				src: {
					type: String,
					value: '',
					notify: true
				},
				wavesurfer: {
					type: Object,
					value: null
				},
				wavecolor: {
					type: String,
					value: '#ffffff',
					notify: true
				},
				progresscolor: {
					type: String,
					value: '#CFD8DC',
					notify: true
				},
				loadingval: {
					type: String,
					value: 0
				},
				isInitialized: {
					type: Boolean,
					value: false
				},
				sharedElements: {
					value: function() {
						return {
							'hero': this.$.container,
							'ripple': this.$.container,
							'reverse-ripple' : this.$.pausebutton
						}
					}
				},
				animationConfig: {
					value: function() {
						return {
							'entry': [{
								name: 'ripple-animation',
								id: 'ripple',
              	toPage: this,
								timing: {
									duration: 500
								}
							}],
							'exit': [{
								name: 'fade-out-animation',
								node: this.$.container,
								timing: {
									duration: 1000
								}
							}]
						}
					}
				}
			},
			togglePlay: function() {
				this.pause();
				this.handlePause();
			},
			handlePause: function() {
				this.$.wavecontainer.style.opacity = 0;
				this.$.controls.style.opacity = 0;
				this.fire('pause-click');
			},
			initWaveSurfer: function() {
				var self = this;
				this.$.controls.style.opacity = 0;

				this.wavesurfer.init({
					container: this.$.wavecontainer,
					waveColor: this.wavecolor,
					progressColor: this.progresscolor,
					fillParent: true,
					height: 100
				});
				this.isInitialized = true;

				this.wavesurfer.on('ready', function () {
					self.wavesurfer.play();
				});
				
				this.wavesurfer.on('error', function(e) {
					setTimeout( function () {
						self.$.error.show();
					}, 2000);
					setTimeout( function () {
						self.wavesurfer.destroy();
						self.isInitialized = false;
						self.togglePlay();
						self.fire('error');
					}, 5000);
				});
				
				this.wavesurfer.load(this.src);

				this.wavesurfer.on('finish', function () {
					self.togglePlay();
				});
				
				this.wavesurfer.on('ready', function () {
					self.$.notification.style.display = "none";
				});

				this.wavesurfer.on('loading', function (e) {
					self.loadingval = e;
					if(e == 100) {
						setTimeout( function () {
							self.$.controls.style.opacity = 1;
						}, 1000);
						self.$.loadmeter.style.display = "none";
					} else {
						self.$.controls.style.opacity = 0;
					}
				});
			},
			updateWavesurfer: function() {
				this.wavesurfer = Object.create(WaveSurfer);
			},
			play: function() {
				this.wavesurfer.play();
			},
			pause: function() {
				this.wavesurfer.pause();
			},
			mute: function() {
				this.wavesurfer.toggleMute();
			},
			replay: function() {
				this.wavesurfer.skip(-30);
			},
			freeUpMemory: function(){
				if(this.isInitialized && this.wavesurfer.isPlaying != "undefined") {
					this.wavesurfer.pause();
					this.wavesurfer.destroy();
					this.isInitialized = false;
					this.fire("error");
					this.handlePause();
				}
			}
		});
	})();
</script>
